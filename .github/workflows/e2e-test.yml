name: e2e-test-workflow

on:
  workflow_dispatch:
  push:
    branches:
      - 'develop'
      - 'feature/**'
    paths:
      - 'test/**'
      - '.github/workflows/e2e-test.yml'
  schedule:
    # JST 14:00-16:30 の間、30分ごとに実行
    # UTC 05:00-07:30 (JST 14:00-16:30)
    # 1-5 で 月曜日から金曜日
    - cron: "0,30 5-7 * * 1-5"  # UTC 05:00-07:30 (JST 14:00-16:30)


env:
  TEST_SORA_MODE_SIGNALING_URLS: ${{ secrets.TEST_SIGNALING_URLS }}
  TEST_SORA_MODE_CHANNEL_ID_PREFIX: ${{ secrets.TEST_CHANNEL_ID_PREFIX }}
  TEST_SORA_MODE_SECRET_KEY: ${{ secrets.TEST_SECRET_KEY }}
  OPENH264_VERSION: 2.6.0

jobs:
  e2e-test:
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            package: ubuntu-22.04_x86_64
          - os: ubuntu-24.04
            package: ubuntu-24.04_x86_64
          - os: macos-15
            package: macos_arm64
          # Windows サポート予定
          #- os: windows-2022
          #  package: windows_x86_64
    name: E2E Test ${{ matrix.package }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
      
      - name: Install runtime dependencies
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates libdrm2 libva2 libva-drm2
      
      - name: Download and extract momo binary
        uses: ./.github/actions/download-binary
        with:
          platform: ${{ matrix.package }}
          github-token: ${{ github.token }}
      
      - name: Download OpenH264
        uses: shiguredo/github-actions/.github/actions/download-openh264@main
        id: openh264
        with:
          platform_name: ${{ matrix.package }}
          openh264_version: ${{ env.OPENH264_VERSION }}
          use-cache: true

      - name: Setup OpenH264 environment
        run: echo "OPENH264_PATH=${{ steps.openh264.outputs.openh264_path }}" >> $GITHUB_ENV
      
      - uses: astral-sh/setup-uv@v6
      
      - name: Run E2E tests
        run: |
          uv sync
          uv run pytest -v
        working-directory: ./test

  e2e-test-hwa:
    strategy:
      matrix:
        include:
          - name: Apple Video Toolbox
            runner_labels: '["self-hosted", "macOS", "ARM64", "Apple-M2-Pro"]'
            test_file: test_sora_mode_apple_video_toolbox.py
            platform: macos_arm64
            env_vars: |
              APPLE_VIDEO_TOOLBOX=true
          - name: Intel VPL
            runner_labels: '["self-hosted", "linux", "x64", "Intel-VPL"]'
            test_file: test_sora_mode_intel_vpl.py
            platform: ubuntu-24.04_x86_64
            env_vars: |
              INTEL_VPL=true
              LIBVA_MESSAGING_LEVEL=0
          - name: NVIDIA Video Codec SDK
            runner_labels: '["self-hosted", "linux", "x64", "NVIDIA-Video-Codec-SDK"]'
            test_file: test_sora_mode_nvidia_video_codec_sdk.py
            platform: ubuntu-24.04_x86_64
            env_vars: |
              NVIDIA_VIDEO_CODEC_SDK=true
    name: E2E Test HWA ${{ matrix.name }}
    runs-on:
      group: Self
      labels: ${{ fromJSON(matrix.runner_labels) }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Homebrew
        if: startsWith(matrix.platform, 'macos')
        uses: Homebrew/actions/setup-homebrew@master
      
      - name: Install GitHub CLI
        if: startsWith(matrix.platform, 'macos')
        run: brew install gh
      
      - name: Set environment variables
        run: |
          echo "${{ matrix.env_vars }}" | while read line; do
            if [ -n "$line" ]; then
              echo "$line" >> $GITHUB_ENV
            fi
          done
      
      - name: Download and extract momo binary
        uses: ./.github/actions/download-binary
        with:
          platform: ${{ matrix.platform }}
          github-token: ${{ github.token }}
      
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false
      
      - name: Run HW accelerated E2E tests
        run: |
          uv sync
          uv run pytest ${{ matrix.test_file }} -v
        working-directory: ./test
