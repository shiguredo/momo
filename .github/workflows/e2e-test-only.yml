name: e2e-test-only

on:
  workflow_dispatch:
  push:
    branches:
      - 'develop'
      - 'feature/pytest-*'
    paths:
      - 'test/**'
      - '.github/workflows/e2e-test-only.yml'
  schedule:
    # JST 10:00-16:30 の間、30分ごとに実行
    # UTC 01:00-07:30 (JST 10:00-16:30)
    # 1-5 で 月曜日から金曜日
    - cron: "0,30 1-7 * * 1-5"  # UTC 01:00-07:30 (JST 10:00-16:30)


env:
  TEST_SORA_MODE_SIGNALING_URLS: ${{ secrets.TEST_SIGNALING_URLS }}
  TEST_SORA_MODE_CHANNEL_ID_PREFIX: ${{ secrets.TEST_CHANNEL_ID_PREFIX }}
  TEST_SORA_MODE_SECRET_KEY: ${{ secrets.TEST_SECRET_KEY }}
  OPENH264_VERSION: 2.6.0

jobs:
  e2e-test-ubuntu:
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            package: ubuntu-22.04_x86_64
          - os: ubuntu-24.04
            package: ubuntu-24.04_x86_64
    name: E2E Test ${{ matrix.package }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5
      
      - name: Install runtime dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates libdrm2 libva2 libva-drm2
      
      - name: Download and extract momo binary
        uses: ./.github/actions/download-release
        with:
          platform: ${{ matrix.package }}
          github-token: ${{ github.token }}
      
      - name: Cache OpenH264
        id: cache-openh264
        uses: actions/cache@v4
        with:
          path: libopenh264.so
          key: openh264-${{ env.OPENH264_VERSION }}-linux64

      - name: Download OpenH264
        if: steps.cache-openh264.outputs.cache-hit != 'true'
        run: |
          curl -L -o libopenh264.so.bz2 http://ciscobinary.openh264.org/libopenh264-${{ env.OPENH264_VERSION }}-linux64.8.so.bz2
          bunzip2 libopenh264.so.bz2
          chmod +x libopenh264.so

      - name: Setup OpenH264 environment
        run: echo "OPENH264_PATH=${{ github.workspace }}/libopenh264.so" >> $GITHUB_ENV
      
      - uses: astral-sh/setup-uv@v6
      
      - name: Run E2E tests
        run: |
          uv sync
          uv run pytest -v
        working-directory: ./test

  e2e-test-macos:
    name: E2E Test macos_arm64
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v5
      
      - name: Download and extract momo binary
        uses: ./.github/actions/download-release
        with:
          platform: macos_arm64
          github-token: ${{ github.token }}
      
      - uses: astral-sh/setup-uv@v6
      
      - name: Run E2E tests
        run: |
          uv sync
          uv run pytest -v -s
        working-directory: ./test

  e2e-test-hwa:
    strategy:
      matrix:
        include:
          - name: Apple Video Toolbox
            runner_labels: '["self-hosted", "macOS", "ARM64", "Apple-M2-Pro"]'
            test_file: test_sora_mode_apple_video_toolbox.py
            platform: macos_arm64
            env_vars: |
              APPLE_VIDEO_TOOLBOX=true
          - name: Intel VPL
            runner_labels: '["self-hosted", "linux", "x64", "Intel-VPL"]'
            test_file: test_sora_mode_intel_vpl.py
            platform: ubuntu-24.04_x86_64
            env_vars: |
              INTEL_VPL=true
              LIBVA_MESSAGING_LEVEL=0
          - name: NVIDIA Video Codec SDK
            runner_labels: '["self-hosted", "linux", "x64", "NVIDIA-Video-Codec-SDK"]'
            test_file: test_sora_mode_nvidia_video_codec_sdk.py
            platform: ubuntu-24.04_x86_64
            env_vars: |
              NVIDIA_VIDEO_CODEC_SDK=true
    name: E2E Test HWA ${{ matrix.name }}
    runs-on:
      group: Self
      labels: ${{ fromJSON(matrix.runner_labels) }}
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Homebrew
        if: startsWith(matrix.platform, 'macos')
        uses: Homebrew/actions/setup-homebrew@master
      
      - name: Install GitHub CLI
        if: startsWith(matrix.platform, 'macos')
        run: brew install gh
      
      - name: Set environment variables
        run: |
          echo "${{ matrix.env_vars }}" | while read line; do
            if [ -n "$line" ]; then
              echo "$line" >> $GITHUB_ENV
            fi
          done
      
      - name: Download and extract momo binary
        uses: ./.github/actions/download-release
        with:
          platform: ${{ matrix.platform }}
          github-token: ${{ github.token }}
      
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false
      
      - name: Run HW accelerated E2E tests
        run: |
          uv sync
          uv run pytest ${{ matrix.test_file }} -v
        working-directory: ./test
