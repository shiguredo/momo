# Momo の統計情報を取得する

## 概要

Momo には統計情報を HTTP API 経由で JSON 形式で取得することができる MetricsServer が内臓されています。ここでは、MetricsServer の起動方法、レスポンスの形式などについて説明します。

## MetricsServer の起動方法

デフォルトでは MetricsServer は起動しません。起動させたい場合は、`--metrics-port` オプションでポート番号を指定してください。8081 番ポートで起動させたい場合は、次のように指定してください。

```
$ ./momo --metrics-port 8081 <mode>
```

MetricsServer はデフォルトでループバック (127.0.0.1 で listen) アドレスからのみアクセス可能です。グローバル (0.0.0.0 で listen) アクセスを許可する場合は `--metrics-allow-external-ip` 引数を指定してください。

## 統計情報 API

### URL

統計情報を取得するには HTTP の GET メソッドを利用して `/metrics` にアクセスしてください。例えば、次のオプションで Momo を起動した場合、

```
$ ./momo --metrics-port 8081 test
```

http://127.0.0.1:8081/metrics にブラウザ、または `curl` などの HTTP クライアントでアクセスすることで統計情報を取得することができます。

### 統計情報 JSON の仕様

統計情報は JSON 形式で取得することができます。JSON に含まれる内容は次の通りです。

```json
{
  "version": "MomoVersion::GetClientName() の戻り値",
  "libwebrtc": "MomoVersion::GetLibwebrtcName() の戻り値",
  "environment": "MomoVersion::GetEnvironmentName() の戻り値",
  "stats": [`werbrtc::RTCStats`, ...] // Sora モードの pong メッセージに含まれるものと同じ"
}
```

実際のレスポンスの例は次のようになります。

```json
{
  "version": "WebRTC Native Client Momo 2020.10 (b7a36d2e)",
  "libwebrtc": "Shiguredo-Build M88.4324@{#2} (88.4324.2.0 54bd8488)",
  "environment": "[aarch64] Ubuntu 18.04.5 LTS (nvidia-l4t-core 32.4.4-20201016123640)",
  "stats": "[{\"type\":\"certificate\",\"id\":\"RTCCertificate_AD:20:F7:8B:68:BF:3A:46:82:C1:8F:FB:FC:C2:04:3A:AD:E9:44:8C:BD:7A:C6:4C:6E:06:D8:0B:97:C3:7E:63\",\"timestamp\":1607958022672100,\"fingerprint\":\"AD:20:F7:8B:68:BF:3A:46:82:C1:8F:FB:FC:C2:04:3A:AD:E9:44:8C:BD:7A:C6:4C:6E:06:D8:0B:97:C3:7E:63\",\"fingerprintAlgorithm\":\"sha-256\",\"base64Certificate\":\"MIIBFTCBvaADAgECAgkA8hsLJlNkECYwCgYIKoZIzj0EAwIwETEPMA0GA1UEAwwGV2ViUlRDMB4XDTIwMTIxMzE1MDAwNVoXDTIxMDExMzE1MDAwNVowETEPMA0GA1UEAwwGV2ViUlRDMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAExnkvYwY7I7mxplYk6yIk5Qi7UALNueyq931uL5OFwD/RkbFnQn4NNxi1Bc7GyGHlaR8MshTu7FDMufMCwOflPTAKBggqhkjOPQQDAgNHADBEAiAG+I0dZW0cEliJ15u7vGMk8tXphuXcbhRKlSsdwNYOXAIgO2GDnhn4algd3WB84o/coaebUSaXX5SVVutYiukKp5M=\"},{\"type\":\"certificate\",\"id\":\"RTCCertificate_EF:2F:EC:7A:36:B8:4E:12:06:CE:ED:AB:85:F8:BF:D3:F6:C7:2A:05:BC:94:1B:27:C1:DC:6B:34:2C:7F:6A:99\",\"timestamp\":1607958022672100,\"fingerprint\":\"EF:2F:EC:7A:36:B8:4E:12:06:CE:ED:AB:85:F8:BF:D3:F6:C7:2A:05:BC:94:1B:27:C1:DC:6B:34:2C:7F:6A:99\",\"fingerprintAlgorithm\":\"sha-256\",\"base64Certificate\":\"MIIBFTCBvaADAgECAgkAhU8U4HRbUlYwCgYIKoZIzj0EAwIwETEPMA0GA1UEAwwGV2ViUlRDMB4XDTIwMTIxMzE1MDAwNVoXDTIxMDExMzE1MDAwNVowETEPMA0GA1UEAwwGV2ViUlRDMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE/v53BQzG+/2tK3NOiWLyw0WEAgKBKpDg3MzLXCCtncsb5HRtK07TY3Bl8v4mdvgGR981lZwdvgwh6x4dSFSHIzAKBggqhkjOPQQDAgNHADBEAiA2n/TQLvkF+IfY0J9ok8vI6odqN+N9LrHQpkFBii0STQIgGHnzBTXE40k0OBNRZ2V160lntE+LnavA/xRU2BMlK60=\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_102\",\"timestamp\":1607958022672100,\"payloadType\":102,\"mimeType\":\"video/H264\",\"clockRate\":90000,\"sdpFmtpLine\":\"level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_107\",\"timestamp\":1607958022672100,\"payloadType\":107,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=125\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_108\",\"timestamp\":1607958022672100,\"payloadType\":108,\"mimeType\":\"video/H264\",\"clockRate\":90000,\"sdpFmtpLine\":\"level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42e01f\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_109\",\"timestamp\":1607958022672100,\"payloadType\":109,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=108\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_114\",\"timestamp\":1607958022672100,\"payloadType\":114,\"mimeType\":\"video/red\",\"clockRate\":90000},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_115\",\"timestamp\":1607958022672100,\"payloadType\":115,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=114\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_116\",\"timestamp\":1607958022672100,\"payloadType\":116,\"mimeType\":\"video/ulpfec\",\"clockRate\":90000},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_120\",\"timestamp\":1607958022672100,\"payloadType\":120,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=127\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_121\",\"timestamp\":1607958022672100,\"payloadType\":121,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=102\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_125\",\"timestamp\":1607958022672100,\"payloadType\":125,\"mimeType\":\"video/H264\",\"clockRate\":90000,\"sdpFmtpLine\":\"level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Inbound_127\",\"timestamp\":1607958022672100,\"payloadType\":127,\"mimeType\":\"video/H264\",\"clockRate\":90000,\"sdpFmtpLine\":\"level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42001f\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_102\",\"timestamp\":1607958022672100,\"payloadType\":102,\"mimeType\":\"video/H264\",\"clockRate\":90000,\"sdpFmtpLine\":\"level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_107\",\"timestamp\":1607958022672100,\"payloadType\":107,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=125\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_108\",\"timestamp\":1607958022672100,\"payloadType\":108,\"mimeType\":\"video/H264\",\"clockRate\":90000,\"sdpFmtpLine\":\"level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42e01f\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_109\",\"timestamp\":1607958022672100,\"payloadType\":109,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=108\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_114\",\"timestamp\":1607958022672100,\"payloadType\":114,\"mimeType\":\"video/red\",\"clockRate\":90000},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_115\",\"timestamp\":1607958022672100,\"payloadType\":115,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=114\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_116\",\"timestamp\":1607958022672100,\"payloadType\":116,\"mimeType\":\"video/ulpfec\",\"clockRate\":90000},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_120\",\"timestamp\":1607958022672100,\"payloadType\":120,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=127\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_121\",\"timestamp\":1607958022672100,\"payloadType\":121,\"mimeType\":\"video/rtx\",\"clockRate\":90000,\"sdpFmtpLine\":\"apt=102\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_125\",\"timestamp\":1607958022672100,\"payloadType\":125,\"mimeType\":\"video/H264\",\"clockRate\":90000,\"sdpFmtpLine\":\"level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\"},{\"type\":\"codec\",\"id\":\"RTCCodec_0_Outbound_127\",\"timestamp\":1607958022672100,\"payloadType\":127,\"mimeType\":\"video/H264\",\"clockRate\":90000,\"sdpFmtpLine\":\"level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42001f\"},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_0\",\"timestamp\":1607958022672100,\"payloadType\":0,\"mimeType\":\"audio/PCMU\",\"clockRate\":8000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_103\",\"timestamp\":1607958022672100,\"payloadType\":103,\"mimeType\":\"audio/ISAC\",\"clockRate\":16000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_104\",\"timestamp\":1607958022672100,\"payloadType\":104,\"mimeType\":\"audio/ISAC\",\"clockRate\":32000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_105\",\"timestamp\":1607958022672100,\"payloadType\":105,\"mimeType\":\"audio/CN\",\"clockRate\":16000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_106\",\"timestamp\":1607958022672100,\"payloadType\":106,\"mimeType\":\"audio/CN\",\"clockRate\":32000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_110\",\"timestamp\":1607958022672100,\"payloadType\":110,\"mimeType\":\"audio/telephone-event\",\"clockRate\":48000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_111\",\"timestamp\":1607958022672100,\"payloadType\":111,\"mimeType\":\"audio/opus\",\"clockRate\":48000,\"channels\":2,\"sdpFmtpLine\":\"minptime=10;useinbandfec=1\"},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_112\",\"timestamp\":1607958022672100,\"payloadType\":112,\"mimeType\":\"audio/telephone-event\",\"clockRate\":32000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_113\",\"timestamp\":1607958022672100,\"payloadType\":113,\"mimeType\":\"audio/telephone-event\",\"clockRate\":16000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_126\",\"timestamp\":1607958022672100,\"payloadType\":126,\"mimeType\":\"audio/telephone-event\",\"clockRate\":8000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_13\",\"timestamp\":1607958022672100,\"payloadType\":13,\"mimeType\":\"audio/CN\",\"clockRate\":8000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_8\",\"timestamp\":1607958022672100,\"payloadType\":8,\"mimeType\":\"audio/PCMA\",\"clockRate\":8000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Inbound_9\",\"timestamp\":1607958022672100,\"payloadType\":9,\"mimeType\":\"audio/G722\",\"clockRate\":8000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_0\",\"timestamp\":1607958022672100,\"payloadType\":0,\"mimeType\":\"audio/PCMU\",\"clockRate\":8000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_103\",\"timestamp\":1607958022672100,\"payloadType\":103,\"mimeType\":\"audio/ISAC\",\"clockRate\":16000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_104\",\"timestamp\":1607958022672100,\"payloadType\":104,\"mimeType\":\"audio/ISAC\",\"clockRate\":32000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_105\",\"timestamp\":1607958022672100,\"payloadType\":105,\"mimeType\":\"audio/CN\",\"clockRate\":16000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_106\",\"timestamp\":1607958022672100,\"payloadType\":106,\"mimeType\":\"audio/CN\",\"clockRate\":32000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_110\",\"timestamp\":1607958022672100,\"payloadType\":110,\"mimeType\":\"audio/telephone-event\",\"clockRate\":48000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_111\",\"timestamp\":1607958022672100,\"payloadType\":111,\"mimeType\":\"audio/opus\",\"clockRate\":48000,\"channels\":2,\"sdpFmtpLine\":\"minptime=10;useinbandfec=1\"},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_112\",\"timestamp\":1607958022672100,\"payloadType\":112,\"mimeType\":\"audio/telephone-event\",\"clockRate\":32000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_113\",\"timestamp\":1607958022672100,\"payloadType\":113,\"mimeType\":\"audio/telephone-event\",\"clockRate\":16000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_126\",\"timestamp\":1607958022672100,\"payloadType\":126,\"mimeType\":\"audio/telephone-event\",\"clockRate\":8000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_13\",\"timestamp\":1607958022672100,\"payloadType\":13,\"mimeType\":\"audio/CN\",\"clockRate\":8000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_8\",\"timestamp\":1607958022672100,\"payloadType\":8,\"mimeType\":\"audio/PCMA\",\"clockRate\":8000,\"channels\":1},{\"type\":\"codec\",\"id\":\"RTCCodec_1_Outbound_9\",\"timestamp\":1607958022672100,\"payloadType\":9,\"mimeType\":\"audio/G722\",\"clockRate\":8000,\"channels\":1},{\"type\":\"data-channel\",\"id\":\"RTCDataChannel_1\",\"timestamp\":1607958022672100,\"label\":\"serial\",\"protocol\":\"\",\"dataChannelIdentifier\":1,\"state\":\"open\",\"messagesSent\":0,\"bytesSent\":0,\"messagesReceived\":0,\"bytesReceived\":0},{\"type\":\"candidate-pair\",\"id\":\"RTCIceCandidatePair_fjuNt10L_m6pz3wYT\",\"timestamp\":1607958022672100,\"transportId\":\"RTCTransport_0_1\",\"localCandidateId\":\"RTCIceCandidate_fjuNt10L\",\"remoteCandidateId\":\"RTCIceCandidate_m6pz3wYT\",\"state\":\"succeeded\",\"priority\":9.079290933588803e+18,\"nominated\":true,\"writable\":true,\"bytesSent\":6381086,\"bytesReceived\":20544,\"totalRoundTripTime\":0.043,\"currentRoundTripTime\":0.004,\"availableOutgoingBitrate\":6648090,\"requestsReceived\":10,\"requestsSent\":1,\"responsesReceived\":10,\"responsesSent\":10,\"consentRequestsSent\":9},{\"type\":\"local-candidate\",\"id\":\"RTCIceCandidate_fjuNt10L\",\"timestamp\":1607958022672100,\"transportId\":\"RTCTransport_0_1\",\"isRemote\":false,\"networkType\":\"wifi\",\"ip\":\"192.168.0.2\",\"port\":38002,\"protocol\":\"udp\",\"candidateType\":\"host\",\"priority\":2122194687,\"deleted\":false},{\"type\":\"remote-candidate\",\"id\":\"RTCIceCandidate_m6pz3wYT\",\"timestamp\":1607958022672100,\"transportId\":\"RTCTransport_0_1\",\"isRemote\":true,\"ip\":\"\",\"port\":58052,\"protocol\":\"udp\",\"candidateType\":\"host\",\"priority\":2113937151,\"deleted\":false},{\"type\":\"track\",\"id\":\"RTCMediaStreamTrack_sender_1\",\"timestamp\":1607958022672100,\"trackIdentifier\":\"OIetL3IJhX8oDXMj7/5NWQZs4sxm6CIA\",\"mediaSourceId\":\"RTCVideoSource_1\",\"remoteSource\":false,\"ended\":false,\"detached\":false,\"kind\":\"video\",\"frameWidth\":3840,\"frameHeight\":2160,\"framesSent\":491,\"hugeFramesSent\":3},{\"type\":\"stream\",\"id\":\"RTCMediaStream_aHkiqgrZ5X4y8n3CI5/4XJqRkjocabs5\",\"timestamp\":1607958022672100,\"streamIdentifier\":\"aHkiqgrZ5X4y8n3CI5/4XJqRkjocabs5\",\"trackIds\":[\"RTCMediaStreamTrack_sender_1\"]},{\"type\":\"outbound-rtp\",\"id\":\"RTCOutboundRTPVideoStream_1885458083\",\"timestamp\":1607958022672100,\"ssrc\":1885458083,\"isRemote\":false,\"mediaType\":\"video\",\"kind\":\"video\",\"trackId\":\"RTCMediaStreamTrack_sender_1\",\"transportId\":\"RTCTransport_0_1\",\"codecId\":\"RTCCodec_0_Outbound_102\",\"firCount\":0,\"pliCount\":0,\"nackCount\":0,\"qpSum\":16912,\"mediaSourceId\":\"RTCVideoSource_1\",\"remoteId\":\"RTCRemoteInboundRtpVideoStream_1885458083\",\"packetsSent\":5544,\"retransmittedPacketsSent\":0,\"bytesSent\":6177936,\"headerBytesSent\":136468,\"retransmittedBytesSent\":0,\"framesEncoded\":491,\"keyFramesEncoded\":6,\"totalEncodeTime\":16.86,\"totalEncodedBytesTarget\":0,\"frameWidth\":3840,\"frameHeight\":2160,\"framesPerSecond\":30,\"framesSent\":491,\"hugeFramesSent\":3,\"totalPacketSendDelay\":369.95,\"qualityLimitationReason\":\"none\",\"qualityLimitationResolutionChanges\":0,\"encoderImplementation\":\"Jetson Video Encoder\"},{\"type\":\"peer-connection\",\"id\":\"RTCPeerConnection\",\"timestamp\":1607958022672100,\"dataChannelsOpened\":1,\"dataChannelsClosed\":0},{\"type\":\"remote-inbound-rtp\",\"id\":\"RTCRemoteInboundRtpVideoStream_1885458083\",\"timestamp\":1607958021985821,\"ssrc\":1885458083,\"kind\":\"video\",\"transportId\":\"RTCTransport_0_1\",\"codecId\":\"RTCCodec_0_Outbound_102\",\"packetsLost\":0,\"jitter\":0.009988888888888889,\"localId\":\"RTCOutboundRTPVideoStream_1885458083\",\"roundTripTime\":0.005},{\"type\":\"transport\",\"id\":\"RTCTransport_0_1\",\"timestamp\":1607958022672100,\"bytesSent\":6381086,\"packetsSent\":5691,\"bytesReceived\":20544,\"packetsReceived\":344,\"dtlsState\":\"connected\",\"selectedCandidatePairId\":\"RTCIceCandidatePair_fjuNt10L_m6pz3wYT\",\"localCertificateId\":\"RTCCertificate_AD:20:F7:8B:68:BF:3A:46:82:C1:8F:FB:FC:C2:04:3A:AD:E9:44:8C:BD:7A:C6:4C:6E:06:D8:0B:97:C3:7E:63\",\"remoteCertificateId\":\"RTCCertificate_EF:2F:EC:7A:36:B8:4E:12:06:CE:ED:AB:85:F8:BF:D3:F6:C7:2A:05:BC:94:1B:27:C1:DC:6B:34:2C:7F:6A:99\",\"tlsVersion\":\"FEFD\",\"dtlsCipher\":\"TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256\",\"srtpCipher\":\"AES_CM_128_HMAC_SHA1_80\",\"selectedCandidatePairChanges\":1},{\"type\":\"media-source\",\"id\":\"RTCVideoSource_1\",\"timestamp\":1607958022672100,\"trackIdentifier\":\"OIetL3IJhX8oDXMj7/5NWQZs4sxm6CIA\",\"kind\":\"video\",\"width\":3840,\"height\":2160,\"framesPerSecond\":30}]"
}
```

## 参考情報

統計情報の `stats` フィールドに含まれる内容の詳細は　W3C の標準仕様 [Identifiers for WebRTC's Statistics API](https://www.w3.org/TR/webrtc-stats/) を参考にしてください。

ただし、2020年12月時点で、この標準仕様はドラフトバージョンであり、また、Momo が利用している libwebrtc バージョンによっては実装されていないものもありますので、注意してください。